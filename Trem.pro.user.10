#include "trem.h"
#include <QtCore>
#include <pthread.h>
#include <semaphore.h>
#include <QDebug>
#include <iostream>

#include <iostream>

#define N 8

sem_t s[N];

//Construtor
Train::Train(int ID, int x, int y) {
    // for (int i = 0; i < N; i++)
    //     sem_init(&s[i], 0, i == 5 ? 1 : 0);
    // 1 = Livre; 2 = Ocupado
    sem_init(&s[0], 0, 1); // Livre
    sem_init(&s[1], 0, 1); // Livre
    sem_init(&s[2], 0, 0); // Ocupado
    sem_init(&s[3], 0, 0); // Ocupado (só funcionou assim)
    sem_init(&s[4], 0, 0); // Ocupado
    sem_init(&s[5], 0, 0); // Livre
    sem_init(&s[6], 0, 1); // Livre


    this->ID = ID;
    this->x = x;
    this->y = y;
    sleep = 99;
    stopped = true;
}

void Train::setSleep(int value) {
    this->sleep = value;
}

void Train::setStopped(bool value) {
    this->stopped = value;
}

//Função a ser executada após executar Train->START
void Train::run() {
    while(true) {
        if(!stopped) {
            switch(ID) {
            case 1: // Train 1
                if (y == 50 && x < 370) { // DIREITA
                    if (x == 350){
                        qDebug() << "T1 Entrou na checagem do 0";
                        if(sem_trywait(&s[0]) == 0) {
                            if(sem_trywait(&s[2]) == 0) {
                                qDebug() << "T1 Alugou 0 e 2";
                            }else {
                                sem_post(&s[0]);
                                break;
                            }
                        }else break;
                    }

                    x += size_movement;
                } else if (x == 370 && y < 180) { // DESCE
                    if (y == 55) sem_post(&s[2]);
                    if (y == 160) sem_wait(&s[2]);

                    y += size_movement;
                } else if (x > 100 && y == 180) { // ESQUERDA
                    if (x == 350)
                        sem_post(&s[0]);

                    x -= size_movement;
                } else { // SOBE
                    if (y == 160)
                        sem_post(&s[2]);

                    y -= size_movement;
                }
                emit updateGUI(ID, x, y);


                break;
            case 2: // Train 2
                if (y == 50 && x < 640) { // DIREITA
                    if (x == 380){
                        qDebug() << "T2 Começou errado";
                        sem_post(&s[0]);
                    }

                    if (x == 620) {
                        sem_wait(&s[1]);
                    }

                    x += size_movement;
                } else if (x == 640 && y < 180) { // DESCE
                    if (y == 160) {
                        if (sem_trywait(&s[0]) == 0) {
                            if (sem_trywait(&s[3]) == 0) {
                                if(sem_trywait(&s[4]) == 0){
                                    qDebug() << "T2 solicitou 0, 3 e 4";
                                }else {
                                    sem_post(&s[0]);
                                    sem_post(&s[3]);
                                    break;
                                }
                            }else {
                                sem_post(&s[0]);
                                break;
                            }
                        }else break;
                    }

                    y += size_movement;
                } else if (x > 370 && y == 180) { // ESQIERDA
                    if (x == 620) {
                        sem_post(&s[1]);
                        sem_post(&s[3]);
                    }

                    if (x == 530) {
                        sem_post(&s[0]);
                        sem_wait(&s[3]);
                    }
                    if (x == 490) {
                        sem_post(&s[4]);
                    }
                    if (x == 390) {
                        qDebug() << "T2 Entrou na checagem do 0";
                        if(sem_trywait(&s[0]) == 0){
                            qDebug() << "T2 Alugou o: 0";
                        }else break;
                    }

                    x -= size_movement;
                } else { // SOBE
                    if (y == 160)
                        sem_post(&s[3]);

                    y -= size_movement;
                }
                emit updateGUI(ID, x, y);

                break;
            case 3: // Train 3
                if (y == 50 && x < 910) { // DIREITA
                    if (x == 655)
                        sem_post(&s[1]);

                    x += size_movement;
                } else if (x == 910 && y < 180) { // DESCE
                    if (y == 160) {
                        if (sem_trywait(&s[5]) == 0) {
                            qDebug() << "T3 solicitou 5";
                            if(sem_trywait(&s[1]) == 0) {
                                qDebug() << "T3 solicitou 1";
                            }else {
                                sem_post(&s[5]);
                                break;
                            }
                        }else break;

                    }

                    y += size_movement;
                }
                else if (x > 640 && y == 180) { // ESQUERDA
                    if (x == 890) sem_post(&s[1]);
                    if (x == 660) sem_wait(&s[1]);

                    x -= size_movement;
                } else { // SOBE
                    if (y == 160) {
                        // sem_post(&s[4]);
                        sem_post(&s[5]);
                    }

                    y -= size_movement;
                }

                emit updateGUI(ID, x, y);

                break;
            case 4: // Train 4
                if (y == 180 && x < 510) { // DIREITA
                    if (x == 350) {// TESTE
                        if (sem_trywait(&s[6]) == 0) {
                            qDebug() << "T4 solicitou 6";
                        }else break;
                    }

                    if (x == 390) {
                        sem_post(&s[2]);
                        // sem_post(&s[6]);
                    }

                    // if (x == 490)
                    // sem_wait(&s[6]);

                    x += size_movement;
                } else if (x == 510 && y < 310) { // DESCE
                    if (y == 200)
                        sem_post(&s[3]);

                    y += size_movement;
                } else if (x > 100 && y == 310) { // ESQUERDA
                    if (x == 490)
                        sem_post(&s[6]);

                    x -= size_movement;
                } else if (x == 100 && y > 180) { // SOBE
                    if (y == 200) {
                        if(sem_trywait(&s[2]) == 0){
                            if(sem_trywait(&s[3]) == 0){
                                qDebug() << "Entrou: 3";
                                for(int i = 0; i < 4; i++){
                                    y -= size_movement;
                                    emit updateGUI(ID, x, y);
                                    msleep(sleep);
                                }

                            }else {
                                sem_post(&s[2]);
                                break;
                            }

                        }else break;
                    }else if (y > 200) y -= size_movement;
                }

                emit updateGUI(ID, x, y);

                break;
            case 5: // Train 5
                if (y == 180 && x < 910) {// DIREITA
                    if (x == 525) sem_post(&s[6]);
                    if (x == 660) sem_post(&s[4]);

                    x += size_movement;
                } else if (x == 910 && y < 310) { // DESCE
                    if (y == 200) sem_post(&s[5]);

                    y += size_movement;
                } else if (x > 510 && y == 310) { // ESQUERDA
                    if (x == 530) {
                        if(sem_trywait(&s[4]) == 0) {
                            if(sem_trywait(&s[6]) == 0) {
                                qDebug() << "T5 solicitou 4 e 6";
                            }else {
                                sem_post(&s[4]);
                                break;
                            }
                        }else break;
                    }
                    x -= size_movement;
                }
                else { // SOBE
                    if (y == 270) {
                        qDebug() << " T5 liberou 4";
                        sem_post(&s[4]);
                    }
                    if (y == 200) {
                        if(sem_trywait(&s[4]) == 0) {
                            if(sem_trywait(&s[5]) == 0) {
                                qDebug() << "T5 solicitou 4 e 5";
                            }else {
                                sem_post(&s[4]);
                                break;
                            }
                        }else break;
                    }

                    y -= size_movement;
                }

                emit updateGUI(ID, x, y);

                break;
            case 6: // Train 6
                if (y == 310 && x < 910) { // DIREITA

                    x += size_movement;
                } else if (x == 910 && y > 50) { // SOBE

                    y -= size_movement;
                } else if (y == 50 && x > 100) { // ESQUERDA

                    x -= size_movement;
                }
                else { // DESCE

                    y += size_movement;
                }

                emit updateGUI(ID, x, y);

                break;

            default:
                break;
            }

            msleep(sleep);
        }
    }
}






